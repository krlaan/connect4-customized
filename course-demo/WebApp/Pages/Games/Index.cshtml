@page
@model WebApp.Pages_Games.IndexModel

@{
    ViewData["Title"] = "Index";
}

<h1 class="text-center my-4">Games</h1>

<div class="d-flex justify-content-center mb-4">
    <a asp-page="/NewGame" asp-route-userId="@Model.UserId" class="btn btn-primary">Create New Game</a>
    
</div>
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm align-middle">
        <thead>
        <tr>
            <th class="text-muted">Game Name</th>
            <th class="text-muted" style="white-space: nowrap;">Player 1 Name</th>
            <th class="text-muted" style="white-space: nowrap;">Player 2 Name</th>
            <th class="text-muted">Configuration</th>
            <th class="text-muted">Game Type</th>
            <th class="text-muted">AI Difficulty</th>
            <th class="text-muted"></th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in Model.Game)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.GameName)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Player1Name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Player2Name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Config!.ConfigName)
                </td>
                <td>
                    @item.Config!.GameTypeDisplayName
                </td>
                <td>
                    @item.Config!.AiDifficultyDisplayName
                </td>
                <td class="text-nowrap">
                    @{
                        var json = !string.IsNullOrEmpty(item.GameState) && item.GameState.TrimStart().StartsWith("{");
                        var state = json ? System.Text.Json.JsonSerializer.Deserialize<BLL.GameState>(item.GameState) : null;
                        var isMultiplayer = state?.IsMultiPlayer ?? false;
                        if (!json && !string.IsNullOrEmpty(item.GameState))
                        {
                            var fileName = item.GameState.EndsWith(".json") ? item.GameState : item.GameState + ".json";
                            var fullPath = System.IO.Path.Combine(DAL.FilesystemHelpers.GetGameDirectory(), fileName);
                            if (System.IO.File.Exists(fullPath))
                            {
                                try
                                {
                                    var jsonText = System.IO.File.ReadAllText(fullPath);
                                    var fromFile = System.Text.Json.JsonSerializer.Deserialize<BLL.GameState>(jsonText);
                                    isMultiplayer = fromFile?.IsMultiPlayer ?? isMultiplayer;
                                }
                                catch
                                {
                                    // ignored
                                }
                            }
                        }
                        var gameId = json || string.IsNullOrEmpty(item.GameState) ? item.Id.ToString() : item.GameState;
                    }
                    @if (isMultiplayer)
                    {
                        <a class="btn btn-primary btn-sm" asp-page="/GamePlay" asp-route-gameId="@gameId" asp-route-userId="@Model.UserId">Join</a>
                    }
                    else
                    {
                        <a class="btn btn-success btn-sm" asp-page="/GamePlay" asp-route-gameId="@gameId" asp-route-userId="@Model.UserId">Continue</a>
                    }
                    <a class="btn btn-outline-danger btn-sm ms-2" asp-page="./Delete" asp-route-id="@gameId" asp-route-userId="@Model.UserId">Delete</a>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>
